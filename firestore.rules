rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin(userId) {
      return isSignedIn() && 
             get(/databases/$(database)/documents/users/$(userId)).data.role == 'Admin';
    }

    function isInstructor(userId) {
      return isSignedIn() && 
             get(/databases/$(database)/documents/users/$(userId)).data.role == 'Instructor';
    }

    function isStudent(userId) {
      return isSignedIn() && 
             get(/databases/$(database)/documents/users/$(userId)).data.role == 'Student';
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }
 
    function isInstructorOrAdmin(userId) {
      return isInstructor(userId) || isAdmin(userId);
    }

    // ==================== USERS COLLECTION ====================
    match /users/{userId} {
      // Read: Any authenticated user can read any user profile (public profiles)
      allow read: if isSignedIn();
      
      // Create: Users can create their own profile on signup
      allow create: if isOwner(userId);
      
      // Update: Users can only update their own profile
      allow update: if isOwner(userId);
      
      // Delete: Only admins can delete user accounts
      allow delete: if isAdmin(request.auth.uid);

      // ==================== USER'S PROGRESS SUBCOLLECTION ====================
      match /progress/{courseId} {
        // Read: Users can only read their own progress
        allow read: if isOwner(userId);
        
        // Create: Users can create their own progress
        allow create: if isOwner(userId) && 
                      request.resource.data.userId == userId &&
                      request.resource.data.courseId is string;
        
        // Update: Users can update their own progress
        allow update: if isOwner(userId) && 
                      resource.data.userId == userId &&
                      request.resource.data.userId == userId;
        
        // Delete: Users can delete their own progress
        allow delete: if isOwner(userId);
      }

      // ==================== USER'S NOTES SUBCOLLECTION ====================
      match /notes/{noteId} {
        // Read: Users can only read their own notes
        allow read: if isOwner(userId);
        
        // Create: Users can create notes for their own lessons
        allow create: if isOwner(userId) && 
                      request.resource.data.userId == userId &&
                      request.resource.data.lessonId is string &&
                      request.resource.data.content is string;
        
        // Update: Users can only update their own notes
        allow update: if isOwner(userId) && 
                      resource.data.userId == userId &&
                      request.resource.data.userId == userId;
        
        // Delete: Users can only delete their own notes
        allow delete: if isOwner(userId) && 
                      resource.data.userId == userId;
      }

      // ==================== USER'S TEST ATTEMPTS SUBCOLLECTION ====================
      match /testAttempts/{attemptId} {
        // Read: Users can only read their own test attempts
        allow read: if isOwner(userId);
        
        // Create: Users can create test attempts for courses
        allow create: if isOwner(userId) && 
                      request.resource.data.userId == userId &&
                      request.resource.data.courseId is string &&
                      request.resource.data.score >= 0;
        
        // Update: Users can update their own test attempts
        allow update: if isOwner(userId) && 
                      resource.data.userId == userId &&
                      request.resource.data.userId == userId;
        
        // Delete: Users can delete their own test attempts
        allow delete: if isOwner(userId) && 
                      resource.data.userId == userId;
      }
    }

    // ==================== COURSES COLLECTION ====================
    match /courses/{courseId} {
      // Read: ANYONE (public) can view all courses for browsing
      allow read: if true;
      
      // Create: Only instructors and admins can create courses
      allow create: if isSignedIn() && 
                     isInstructorOrAdmin(request.auth.uid) &&
                     request.resource.data.instructorId == request.auth.uid &&
                     request.resource.data.title is string &&
                     request.resource.data.description is string;
      
      // Update: Only the course instructor/admin can update their course
      allow update: if isSignedIn() && 
                    isInstructorOrAdmin(request.auth.uid) &&
                    (resource.data.instructorId == request.auth.uid ||
                     isAdmin(request.auth.uid));
      
      // Delete: Only the course instructor/admin can delete their course
      allow delete: if isSignedIn() &&
                    (resource.data.instructorId == request.auth.uid ||
                     isAdmin(request.auth.uid));

      // ==================== LESSONS SUBCOLLECTION ====================
      match /lessons/{lessonId} {
        // Read: ANYONE can read lessons (they can't view full content without purchase)
        allow read: if true;
        
        // Create: Only the course instructor/admin can add lessons
        allow create: if isSignedIn() && 
                      isInstructorOrAdmin(request.auth.uid) &&
                      (get(/databases/$(database)/documents/courses/$(courseId)).data.instructorId == request.auth.uid ||
                       isAdmin(request.auth.uid));
        
        // Update: Only the course instructor/admin can update lessons
        allow update: if isSignedIn() &&
                      isInstructorOrAdmin(request.auth.uid) &&
                      (get(/databases/$(database)/documents/courses/$(courseId)).data.instructorId == request.auth.uid ||
                       isAdmin(request.auth.uid));
        
        // Delete: Only the course instructor/admin can delete lessons
        allow delete: if isSignedIn() &&
                      isInstructorOrAdmin(request.auth.uid) &&
                      (get(/databases/$(database)/documents/courses/$(courseId)).data.instructorId == request.auth.uid ||
                       isAdmin(request.auth.uid));
      }

      // ==================== QUESTIONS SUBCOLLECTION ====================
      match /questions/{questionId} {
        // Read: ANYONE can read questions (answer validation happens on client/server)
        allow read: if true;
        
        // Create: Only the course instructor/admin can add questions
        allow create: if isSignedIn() && 
                      isInstructorOrAdmin(request.auth.uid) &&
                      (get(/databases/$(database)/documents/courses/$(courseId)).data.instructorId == request.auth.uid ||
                       isAdmin(request.auth.uid));
        
        // Update: Only the course instructor/admin can update questions
        allow update: if isSignedIn() &&
                      isInstructorOrAdmin(request.auth.uid) &&
                      (get(/databases/$(database)/documents/courses/$(courseId)).data.instructorId == request.auth.uid ||
                       isAdmin(request.auth.uid));
        
        // Delete: Only the course instructor/admin can delete questions
        allow delete: if isSignedIn() &&
                      isInstructorOrAdmin(request.auth.uid) &&
                      (get(/databases/$(database)/documents/courses/$(courseId)).data.instructorId == request.auth.uid ||
                       isAdmin(request.auth.uid));
      }
    }

    // ==================== PURCHASES COLLECTION ====================
    match /purchases/{purchaseId} {
      // Read: Users can read their own purchases; admins can read all
      allow read: if isSignedIn() && 
                  (resource.data.userId == request.auth.uid ||
                   isAdmin(request.auth.uid));
      
      // Create: Users can create purchases for themselves
      allow create: if isSignedIn() && 
                    request.resource.data.userId == request.auth.uid &&
                    request.resource.data.courseId is string &&
                    request.resource.data.amount >= 0;
      
      // Update: Only admins can update purchases (e.g., refund status)
      allow update: if isSignedIn() && isAdmin(request.auth.uid);
      
      // Delete: Only admins can delete purchases
      allow delete: if isSignedIn() && isAdmin(request.auth.uid);
    }

    // ==================== SAVED COURSES COLLECTION ====================
    match /savedCourses/{savedId} {
      // Read: Users can only read their own saved courses
      allow read: if isSignedIn() && 
                  resource.data.userId == request.auth.uid;
      
      // Create: Users can save courses for themselves
      allow create: if isSignedIn() && 
                    request.resource.data.userId == request.auth.uid &&
                    request.resource.data.courseId is string;
      
      // Update: Users can update their own saved courses
      allow update: if isSignedIn() && 
                    resource.data.userId == request.auth.uid &&
                    request.resource.data.userId == request.auth.uid;
      
      // Delete: Users can unsave their own courses
      allow delete: if isSignedIn() && 
                    resource.data.userId == request.auth.uid;
    }

    // ==================== ENROLLMENTS COLLECTION ====================
    match /enrollments/{enrollmentId} {
      // Read: Allow public read for displaying enrollment counts and student avatars
      // No personal information is exposed - only userId, courseId, status, enrolledAt
      allow read: if true;
      
      // Create: Authenticated users can enroll in courses
      allow create: if isSignedIn() && 
                    request.resource.data.userId == request.auth.uid &&
                    request.resource.data.courseId is string &&
                    request.resource.data.status in ['active', 'completed', 'dropped'];
      
      // Update: Users can update their own enrollment status or admins
      allow update: if isSignedIn() && 
                    (resource.data.userId == request.auth.uid ||
                     isAdmin(request.auth.uid)) &&
                    request.resource.data.status in ['active', 'completed', 'dropped'];
      
      // Delete: Only admins can delete enrollments
      allow delete: if isAdmin(request.auth.uid);
    }

    // ==================== ENROLLMENT STATS COLLECTION (Public Read) ====================
    match /enrollmentStats/{courseId} {
      // Read: ANYONE can read enrollment stats (public analytics for display)
      allow read: if true;
      
      // Create/Update: Only course instructors and admins can update stats
      allow create, update: if isSignedIn() && 
                            (get(/databases/$(database)/documents/courses/$(courseId)).data.instructorId == request.auth.uid ||
                             isAdmin(request.auth.uid));
      
      // Delete: Only admins can delete stats
      allow delete: if isAdmin(request.auth.uid);
    }

    // ==================== COURSE REVIEWS COLLECTION ====================
    match /courseReviews/{reviewId} {
      // Read: ANYONE can read reviews (public feedback)
      allow read: if true;
      
      // Create: Enrolled students can submit reviews
      allow create: if isSignedIn() && 
                    request.resource.data.userId == request.auth.uid &&
                    request.resource.data.courseId is string &&
                    request.resource.data.rating >= 1 && request.resource.data.rating <= 5 &&
                    request.resource.data.title is string &&
                    request.resource.data.comment is string;
      
      // Update: Users can update their own reviews; instructors/admins can mark helpful
      allow update: if isSignedIn() && 
                    (resource.data.userId == request.auth.uid ||
                     get(/databases/$(database)/documents/courses/$(resource.data.courseId)).data.instructorId == request.auth.uid ||
                     isAdmin(request.auth.uid));
      
      // Delete: Users can delete their own reviews; admins can delete inappropriate reviews
      allow delete: if isSignedIn() && 
                    (resource.data.userId == request.auth.uid ||
                     isAdmin(request.auth.uid));
    }

    // ==================== COURSE FEEDBACK COLLECTION ====================
    match /courseFeedback/{feedbackId} {
      // Read: Instructors can read feedback for their courses; admins can read all
      allow read: if isSignedIn() && 
                  (resource.data.userId == request.auth.uid ||
                   get(/databases/$(database)/documents/courses/$(resource.data.courseId)).data.instructorId == request.auth.uid ||
                   isAdmin(request.auth.uid));
      
      // Create: Enrolled students can submit feedback
      allow create: if isSignedIn() && 
                    request.resource.data.userId == request.auth.uid &&
                    request.resource.data.courseId is string &&
                    request.resource.data.type in ['suggestion', 'bug', 'complaint', 'praise'] &&
                    request.resource.data.subject is string &&
                    request.resource.data.message is string;
      
      // Update: Only admins can update feedback status
      allow update: if isSignedIn() && 
                    (isAdmin(request.auth.uid) ||
                     get(/databases/$(database)/documents/courses/$(resource.data.courseId)).data.instructorId == request.auth.uid);
      
      // Delete: Only admins can delete feedback
      allow delete: if isAdmin(request.auth.uid);
    }

    // ==================== COURSE STATS COLLECTION ====================
    match /courseStats/{statsId} {
      // Read: ANYONE can read stats (public analytics)
      allow read: if true;
      
      // Create: Any authenticated user can create stats (for caching)
      allow create: if isSignedIn() && 
                    request.resource.data.courseId is string &&
                    request.resource.data.totalEnrollments >= 0;
      
      // Update: Any authenticated user can update stats (for caching)
      // This allows the client-side caching system to work
      allow update: if isSignedIn();
      
      // Delete: Only admins can delete stats
      allow delete: if isAdmin(request.auth.uid);
    }

    // ==================== INSTRUCTOR PROFILES COLLECTION ====================
    match /instructorProfiles/{userId} {
      // Read: ANYONE can read instructor profiles (public profiles)
      allow read: if true;
      
      // Create/Update: Only the instructor can create/update their own profile
      allow create, update: if isOwner(userId) && 
                             isInstructorOrAdmin(userId);
      
      // Delete: Only admins can delete instructor profiles
      allow delete: if isAdmin(request.auth.uid);
    }

    // ==================== USER PROGRESS COLLECTION ====================
    match /userProgress/{progressId} {
      // Read: Users can only read their own progress
      allow read: if isSignedIn() && 
                  resource.data.userId == request.auth.uid;
      
      // Create: Authenticated users can create their own progress records
      allow create: if isSignedIn() && 
                    request.resource.data.userId == request.auth.uid &&
                    request.resource.data.courseId is string &&
                    request.resource.data.percentage >= 0 &&
                    request.resource.data.percentage <= 100 &&
                    request.resource.data.completedLessons is list &&
                    request.resource.data.totalLessons is number;
      
      // Update: Users can update their own progress
      allow update: if isSignedIn() && 
                    resource.data.userId == request.auth.uid &&
                    request.resource.data.userId == request.auth.uid &&
                    request.resource.data.percentage >= 0 &&
                    request.resource.data.percentage <= 100;
      
      // Delete: Users can delete their own progress
      allow delete: if isSignedIn() && 
                    resource.data.userId == request.auth.uid;
    }

    // ==================== DENY ALL OTHER PATHS ====================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
